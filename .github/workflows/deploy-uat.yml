name: Deploy to UAT Environment

on:
  release:
    types: [published]
  workflow_dispatch:
    inputs:
      release_tag:
        description: 'Release tag to deploy (e.g., v1.0.0)'
        required: true
        type: string

permissions:
  contents: read

jobs:
  validate-release:
    name: ðŸ”’ Validate Release
    runs-on: ubuntu-latest
    outputs:
      release_version: ${{ steps.version.outputs.release_version }}
    steps:
      - name: Determine release version
        id: version
        run: |
          if [[ "${{ github.event_name }}" == "release" ]]; then
            echo "release_version=${{ github.event.release.tag_name }}" >> $GITHUB_OUTPUT
          else
            echo "release_version=${{ github.event.inputs.release_tag }}" >> $GITHUB_OUTPUT
          fi
          echo "Deploying release: ${{ steps.version.outputs.release_version }}"

  deploy-to-uat:
    name: ðŸš€ Deploy to UAT
    runs-on: ubuntu-latest
    needs: [validate-release]
    environment: uat
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          ref: ${{ needs.validate-release.outputs.release_version }}

      - name: Setup Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.10'

      - name: Validate release exists
        run: |
          echo "Deploying release ${{ needs.validate-release.outputs.release_version }} to UAT environment"
          echo "Release URL: ${{ github.server_url }}/${{ github.repository }}/releases/tag/${{ needs.validate-release.outputs.release_version }}"

      - name: Deploy application
        run: |
          echo "ðŸš€ Starting UAT deployment for ${{ needs.validate-release.outputs.release_version }}"
          echo "Region: ${{ vars.AWS_REGION }}"
          # Add your deployment logic here
          # This could include:
          # - Building Docker images
          # - Pushing to container registry
          # - Updating infrastructure
          # - Running database migrations
          # - Health checks
          echo "âœ… UAT deployment completed successfully"

      - name: Post-deployment verification
        run: |
          echo "ðŸ” Running post-deployment verification..."
          # Add health checks and verification steps here
          echo "âœ… UAT environment verification completed"

  notify:
    name: ðŸ“¢ Notify Deployment
    runs-on: ubuntu-latest
    needs: [validate-release, deploy-to-uat]
    if: always()
    
    steps:
      - name: Determine status
        id: status
        run: |
          if [[ "${{ needs.deploy-to-uat.result }}" == "success" ]]; then
            echo "status=âœ… UAT deployment successful" >> $GITHUB_OUTPUT
            echo "color=good" >> $GITHUB_OUTPUT
          else
            echo "status=âŒ UAT deployment failed" >> $GITHUB_OUTPUT
            echo "color=danger" >> $GITHUB_OUTPUT
          fi

      - name: Notify deployment status
        run: |
          echo "${{ steps.status.outputs.status }}"
          echo "Release: ${{ needs.validate-release.outputs.release_version }}"
          echo "Environment: UAT"
          echo "Trigger: ${{ github.event_name }}"