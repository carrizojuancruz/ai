name: Build, Release and Deploy to ECS

on:
  push:
    branches: [develop, uat, main]

permissions:
  id-token: write
  contents: write
  pull-requests: write

jobs:
  resolve-env:
    runs-on: ubuntu-latest
    outputs:
      environment: ${{ steps.map.outputs.environment }}
    steps:
      - name: Map branch to environment
        id: map
        run: |
          case "${{ github.ref_name }}" in
            main)    echo "environment=prod"    >> "$GITHUB_OUTPUT" ;;
            uat)     echo "environment=uat"     >> "$GITHUB_OUTPUT" ;;
            develop) echo "environment=develop" >> "$GITHUB_OUTPUT" ;;
          esac
  deploy:
    needs: [resolve-env]
    uses: verde-money/reusable-workflows/.github/workflows/deploy-ecs.yml@main
    with:
      environment: ${{ needs.resolve-env.outputs.environment }}
    secrets: inherit

  notify-slack:
    needs: [resolve-env, deploy]
    uses: verde-money/reusable-workflows/.github/workflows/slack-notification.yml@main
    with:
      environment: ${{ needs.resolve-env.outputs.environment }}
      version_file_path: "version.json"
      deploy_result: ${{ needs.deploy.result }}
      title: "FOS: ${{ github.repository }} - ${{ needs.resolve-env.outputs.environment }} Deployment"
    secrets:
      SLACK_WEBHOOK_URL: ${{ secrets.DEPLOY_SLACK_WEBHOOK_URL }}
