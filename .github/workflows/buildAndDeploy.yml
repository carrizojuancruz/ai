name: Build and Push to ECR

on:
  push:
    branches:
      - develop
    paths-ignore:
      - ".github/workflows/**"
  workflow_dispatch:
    inputs:
      environment:
        description: "Select deployment environment"
        required: true
        type: choice
        options:
          - develop
          - uat
          - prod

env:
  ECR_REPOSITORY:  ${{ vars.ECR_REGISTRY_NAME }}
  AWS_REGION:      ${{ vars.AWS_REGION }}
  AWS_ACCOUNT_ID:  ${{ vars.AWS_ACCOUNT_ID }}
  ROLE_NAME:       ${{ vars.ROLE_NAME }}
  ECS_CLUSTER:     ${{ vars.ECS_CLUSTER }}
  ECS_SERVICE:     ${{ vars.ECS_SERVICE }}

permissions:
  id-token: write
  contents: read

jobs:

  ## -----------------------------------------
  ## Prepare environment value
  ## -----------------------------------------
  prepare:
    runs-on: ubuntu-latest
    outputs:
      environment: ${{ steps.set-env.outputs.environment }}

    steps:
      - name: Set environment value
        id: set-env
        run: |
          if [ "${{ github.event_name }}" = "push" ]; then
            echo "environment=develop" >> "$GITHUB_OUTPUT"
          else
            echo "environment=${{ github.event.inputs.environment }}" >> "$GITHUB_OUTPUT"
          fi

  ## -----------------------------------------
  ## Deploy job (reusable workflow)
  ## -----------------------------------------
  deploy:
    needs: prepare
    uses: verde-money/reusable-workflows/.github/workflows/deploy-ecs.yml@main
    with:
      environment: ${{ needs.prepare.outputs.environment }}
    secrets:
      inherit


  ## -----------------------------------------
  ## Slack notification
  ## -----------------------------------------
  notify-slack:
    needs: [deploy, prepare]
    uses: verde-money/reusable-workflows/.github/workflows/slack-notification.yml@main
    with:
      environment: ${{ needs.prepare.outputs.environment }}
      version_file_path: "version.json"
      deploy_result: ${{ needs.deploy.result }}
      title: "FOS: ${{ github.repository }} - ${{ needs.prepare.outputs.environment }} Deployment"
    secrets:
      SLACK_WEBHOOK_URL: ${{ vars.DEPLOY_SLACK_WEBHOOK_URL }}
