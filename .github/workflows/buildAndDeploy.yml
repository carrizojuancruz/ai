name: Build, Release and Deploy to ECS

on:
  push:
    branches:
      - develop
    paths-ignore:
      - ".github/workflows/**"
  workflow_dispatch:
    inputs:
      environment:
        description: "Select deployment environment"
        required: true
        type: choice
        options:
          - develop
          - uat
          - prod
      release_notes:
        description: "Release notes"
        required: false
        default: ""

env:
  ECR_REPOSITORY:  ${{ vars.ECR_REGISTRY_NAME }}
  AWS_REGION:      ${{ vars.AWS_REGION }}
  AWS_ACCOUNT_ID:  ${{ vars.AWS_ACCOUNT_ID }}
  ROLE_NAME:       ${{ vars.ROLE_NAME }}
  ECS_CLUSTER:     ${{ vars.ECS_CLUSTER }}
  ECS_SERVICE:     ${{ vars.ECS_SERVICE }}

permissions:
  id-token: write
  contents: read

jobs:

  ## -----------------------------------------
  ## Prepare: detect environment + release type
  ## -----------------------------------------
  prepare:
    runs-on: ubuntu-latest
    outputs:
      environment: ${{ steps.set-env.outputs.environment }}
      release_type: ${{ steps.set-env.outputs.release_type }}
      release_notes: ${{ steps.set-env.outputs.release_notes }}

    steps:
      - name: Set environment + release type
        id: set-env
        run: |
          # Determine environment
          if [ "${{ github.event_name }}" = "push" ]; then
            ENVIRONMENT="${{ github.ref_name }}"
          else
            ENVIRONMENT="${{ github.event.inputs.environment }}"
          fi

          echo "environment=$ENVIRONMENT" >> "$GITHUB_OUTPUT"

          # Determine release type based on environment
          if [ "$ENVIRONMENT" = "develop" ]; then
            RELEASE_TYPE="minor"
          elif [ "$ENVIRONMENT" = "uat" ]; then
            RELEASE_TYPE="patch"
          elif [ "$ENVIRONMENT" = "prod" ]; then
            RELEASE_TYPE="major"
          else
            echo "Invalid environment"
            exit 1
          fi

          echo "release_type=$RELEASE_TYPE" >> "$GITHUB_OUTPUT"

          # Release notes (only for workflow_dispatch)
          echo "release_notes=${{ github.event.inputs.release_notes }}" >> "$GITHUB_OUTPUT"


  ## -----------------------------------------
  ## Create Release (Versioning)
  ## -----------------------------------------
  create-release:
    needs: prepare
    uses: verde-money/reusable-workflows/.github/workflows/create-release.yml@main
    with:
      release_type: ${{ needs.prepare.outputs.release_type }}
      release_notes: ${{ needs.prepare.outputs.release_notes }}
    secrets:
      inherit


  ## -----------------------------------------
  ## Deploy ECS
  ## -----------------------------------------
  deploy:
    needs: [prepare, create-release]
    uses: verde-money/reusable-workflows/.github/workflows/deploy-ecs.yml@main
    with:
      environment: ${{ needs.prepare.outputs.environment }}
    secrets:
      inherit


  ## -----------------------------------------
  ## Slack Notification
  ## -----------------------------------------
  notify-slack:
    needs: [deploy, prepare]
    uses: verde-money/reusable-workflows/.github/workflows/slack-notification.yml@main
    with:
      environment: ${{ needs.prepare.outputs.environment }}
      version_file_path: "version.json"
      deploy_result: ${{ needs.deploy.result }}
      title: "FOS: ${{ github.repository }} - ${{ needs.prepare.outputs.environment }} Deployment"
    secrets:
      SLACK_WEBHOOK_URL: ${{ vars.DEPLOY_SLACK_WEBHOOK_URL }}
