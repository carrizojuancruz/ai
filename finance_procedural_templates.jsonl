{"id": "category-spend-analysis", "name": "Category Spending Analysis", "description": "Analyze spending by category with flexible aggregation", "tags": ["category", "spend", "aggregation"], "sql_hint": "Example: For category spending analysis, you can use flexible GROUP BY with category normalization:\nSELECT\n  COALESCE(ut.provider_tx_category_detailed, ut.category_detailed, ut.provider_tx_category, ut.category, 'Uncategorized') AS category,\n  SUM(CASE WHEN ut.amount < 0 THEN -ut.amount ELSE 0 END) AS total_spend,\n  COUNT(*) AS transaction_count\nFROM public.unified_transactions ut\nWHERE ut.user_id = '{user_id}'\n  AND ut.transaction_date >= CURRENT_DATE - INTERVAL '{days} days'\n  AND COALESCE(ut.pending,false)=false\n  AND COALESCE(ut.is_cancelled,false)=false\n  AND COALESCE(ut.is_payment,false)=false\nGROUP BY category\nORDER BY total_spend DESC", "examples": ["how much did I spend by category", "category breakdown of expenses", "spending analysis by category"], "version": "1.0", "deprecated": false}
{"id": "cash-flow-6m", "name": "Cash Flow (Last 6 Months)", "description": "Monthly income, spending, and net cash flow for the last 6 months.", "tags": ["cash_flow", "trend", "6m"], "sql_hint": "WITH months AS (\n  SELECT date_trunc('month', d)::date AS month\n  FROM generate_series(\n    date_trunc('month', CURRENT_DATE) - INTERVAL '5 months',\n    date_trunc('month', CURRENT_DATE),\n    INTERVAL '1 month'\n  ) d\n),\nagg AS (\n  SELECT\n    date_trunc('month', ut.transaction_date)::date AS month,\n    SUM(CASE WHEN ut.amount > 0 THEN ut.amount ELSE 0 END) AS income,\n    SUM(CASE WHEN ut.amount < 0 THEN -ut.amount ELSE 0 END) AS spend\n  FROM public.unified_transactions ut\n  WHERE ut.user_id = '{user_id}'\n    AND ut.transaction_date >= (date_trunc('month', CURRENT_DATE) - INTERVAL '5 months')\n    AND COALESCE(ut.pending,false)=false\n    AND COALESCE(ut.is_cancelled,false)=false\n    AND COALESCE(ut.is_payment,false)=false\n  GROUP BY 1\n)\nSELECT m.month, COALESCE(a.income,0) AS monthly_income, COALESCE(a.spend,0) AS monthly_spend,\n       COALESCE(a.income,0) - COALESCE(a.spend,0) AS net_cash_flow\nFROM months m\nLEFT JOIN agg a ON a.month = m.month\nORDER BY m.month", "examples": ["cash flow last 6 months", "income and spending trend last six months", "net cash flow recent months"], "version": "1.0", "deprecated": false}
{"id": "upcoming-liability-payments", "name": "Upcoming Liability Payments (Next 45 Days)", "description": "List active liabilities with a due date in the next 45 days and their minimum payments.", "tags": ["liability", "payments", "upcoming"], "sql_hint": "SELECT\n  l.name,\n  l.category,\n  l.minimum_payment_amount,\n  l.next_payment_due_date\nFROM public.unified_liabilities l\nWHERE l.user_id = '{user_id}'\n  AND COALESCE(l.is_active,true)=true\n  AND l.next_payment_due_date IS NOT NULL\n  AND l.next_payment_due_date BETWEEN CURRENT_DATE AND (CURRENT_DATE + INTERVAL '45 days')\nORDER BY l.next_payment_due_date ASC", "examples": ["what bills are due soon", "upcoming liability payments", "minimum payments due next month"], "version": "1.0", "deprecated": false}
{"id": "top-recurring-expenses-6m", "name": "Top Recurring Expenses (Last 6 Months)", "description": "Rank recurring merchants by total spend over the last 6 months.", "tags": ["recurring", "merchant", "top"], "sql_hint": "WITH base AS (\n  SELECT\n    COALESCE(NULLIF(ut.merchant_name,''), NULLIF(ut.name,'')) AS merchant,\n    -ut.amount AS spend\n  FROM public.unified_transactions ut\n  WHERE ut.user_id = '{user_id}'\n    AND ut.transaction_date >= (date_trunc('month', current_date) - INTERVAL '5 months')\n    AND ut.amount < 0\n    AND COALESCE(ut.pending,false)=false\n    AND COALESCE(ut.is_cancelled,false)=false\n    AND COALESCE(ut.is_payment,false)=false\n    AND COALESCE(ut.is_recurring,false)=true\n)\nSELECT merchant, SUM(spend) AS total_recurring_spend, COUNT(*) AS tx_count\nFROM base\nWHERE merchant IS NOT NULL\nGROUP BY merchant\nORDER BY total_recurring_spend DESC\nLIMIT 10", "examples": ["top recurring expenses", "largest recurring merchants", "recurring subscriptions"], "version": "1.0", "deprecated": false}
{"id": "asset-allocation-by-category", "name": "Asset Allocation by Category", "description": "Sum active asset values grouped by category.", "tags": ["assets", "allocation", "category"], "sql_hint": "SELECT\n  ua.category,\n  SUM(ua.estimated_value) AS total_value\nFROM public.unified_assets ua\nWHERE ua.user_id = '{user_id}'\n  AND COALESCE(ua.is_active,true)=true\nGROUP BY ua.category\nORDER BY total_value DESC", "examples": ["asset allocation", "assets by category", "asset mix"], "version": "1.0", "deprecated": false}
{"id": "emergency-mean-median-6m", "name": "Emergency Fund (Mean and Median, Last 6 Months)", "description": "Compute both mean and median monthly spend to recommend 3–6 month emergency fund.", "tags": ["emergency", "median", "mean"], "sql_hint": "WITH m AS (\n  SELECT date_trunc('month', ut.transaction_date) AS month,\n         SUM(CASE WHEN ut.amount < 0 THEN -ut.amount ELSE 0 END) AS monthly_spend\n  FROM public.unified_transactions ut\n  WHERE ut.user_id = '{user_id}'\n    AND ut.transaction_date >= (date_trunc('month', current_date) - INTERVAL '5 months')\n    AND COALESCE(ut.pending,false)=false\n    AND COALESCE(ut.is_cancelled,false)=false\n    AND COALESCE(ut.is_payment,false)=false\n  GROUP BY 1\n)\nSELECT\n  COALESCE(AVG(monthly_spend),0) AS avg_monthly_spend_6m,\n  percentile_cont(0.5) WITHIN GROUP (ORDER BY monthly_spend) AS median_monthly_spend_6m,\n  COALESCE(AVG(monthly_spend),0) * 3 AS recommended_low_mean,\n  COALESCE(AVG(monthly_spend),0) * 6 AS recommended_high_mean,\n  percentile_cont(0.5) WITHIN GROUP (ORDER BY monthly_spend) * 3 AS recommended_low_median,\n  percentile_cont(0.5) WITHIN GROUP (ORDER BY monthly_spend) * 6 AS recommended_high_median\nFROM m", "examples": ["emergency fund mean vs median", "median monthly spend last 6 months", "emergency savings robust"], "version": "1.0", "deprecated": false}
{"id": "financial-health-metrics", "name": "Comprehensive Financial Health Metrics", "description": "Compute key metrics: net worth, recent income/spend, savings rate, and DTI using active assets, liabilities, and recent transactions.", "tags": ["health", "score", "net_worth", "dti", "savings_rate"], "sql_hint": "WITH income_30d AS (\n  SELECT COALESCE(SUM(ut.amount), 0) AS income_30d\n  FROM public.unified_transactions ut\n  WHERE ut.user_id = '{user_id}'\n    AND ut.transaction_date >= CURRENT_DATE - INTERVAL '30 days'\n    AND ut.amount > 0\n    AND COALESCE(ut.pending,false)=false\n    AND COALESCE(ut.is_cancelled,false)=false\n    AND COALESCE(ut.is_payment,false)=false\n),\nspend_30d AS (\n  SELECT COALESCE(SUM(-ut.amount), 0) AS spend_30d\n  FROM public.unified_transactions ut\n  WHERE ut.user_id = '{user_id}'\n    AND ut.transaction_date >= CURRENT_DATE - INTERVAL '30 days'\n    AND ut.amount < 0\n    AND COALESCE(ut.pending,false)=false\n    AND COALESCE(ut.is_cancelled,false)=false\n    AND COALESCE(ut.is_payment,false)=false\n),\nmin_pay AS (\n  SELECT COALESCE(SUM(ul.minimum_payment_amount), 0) AS monthly_debt_payments\n  FROM public.unified_liabilities ul\n  WHERE ul.user_id = '{user_id}' AND COALESCE(ul.is_active, true) = true\n),\nassets_val AS (\n  SELECT COALESCE(SUM(ua.estimated_value), 0) AS total_assets\n  FROM public.unified_assets ua\n  WHERE ua.user_id = '{user_id}' AND COALESCE(ua.is_active, true) = true\n),\nliabs_principal AS (\n  SELECT COALESCE(SUM(ul.principal_balance), 0) AS total_liabilities_principal\n  FROM public.unified_liabilities ul\n  WHERE ul.user_id = '{user_id}' AND COALESCE(ul.is_active, true) = true\n)\nSELECT\n  a.total_assets,\n  l.total_liabilities_principal,\n  a.total_assets - l.total_liabilities_principal AS net_worth,\n  i.income_30d,\n  s.spend_30d,\n  CASE WHEN i.income_30d > 0 THEN 1 - (s.spend_30d / i.income_30d) ELSE NULL END AS savings_rate_30d,\n  m.monthly_debt_payments AS monthly_debt_payments,\n  CASE WHEN i.income_30d > 0 THEN m.monthly_debt_payments / i.income_30d ELSE NULL END AS dti_min_payment\nFROM assets_val a, liabs_principal l, income_30d i, spend_30d s, min_pay m", "examples": ["what's my financial health score", "what's my overall financial health", "show net worth, recent savings rate, and debt-to-income"], "version": "1.0", "deprecated": false}
{"id": "spending-trends-ytd", "name": "Spending and Income Trends (Year-to-Date)", "description": "Monthly spending and income trends for the current year (fills missing months; one query, no pre-checks).", "tags": ["trend", "ytd", "timeseries", "monthly"], "sql_hint": "WITH months AS (\n  SELECT date_trunc('month', d)::date AS month\n  FROM generate_series(\n    date_trunc('year', current_date)::date,\n    date_trunc('year', current_date)::date + interval '11 months',\n    interval '1 month'\n  ) d\n),\nagg AS (\n  SELECT\n    date_trunc('month', ut.transaction_date)::date AS month,\n    SUM(CASE WHEN ut.amount < 0 THEN -ut.amount ELSE 0 END) AS monthly_spend,\n    SUM(CASE WHEN ut.amount > 0 THEN ut.amount ELSE 0 END) AS monthly_income\n  FROM public.unified_transactions ut\n  WHERE ut.user_id = '{user_id}'\n    AND ut.transaction_date >= date_trunc('year', current_date)\n    AND COALESCE(ut.pending,false)=false\n    AND COALESCE(ut.is_cancelled,false)=false\n    AND COALESCE(ut.is_payment,false)=false\n  GROUP BY 1\n)\nSELECT m.month, COALESCE(a.monthly_spend,0) AS monthly_spend, COALESCE(a.monthly_income,0) AS monthly_income\nFROM months m LEFT JOIN agg a ON a.month = m.month\nORDER BY m.month ASC", "examples": ["how are my spending trends this year", "spending and income by month this year", "year to date spending trend"], "version": "1.1", "deprecated": false}
{"id": "merchant-spend-12m-minimal", "name": "Merchant Spend (12M, One-Shot Minimal)", "description": "Compute total spend at a merchant over the past 12 months in a single statement (no pre-checks).", "tags": ["merchant", "spend", "12m", "one_shot"], "sql_hint": "SELECT\n  COALESCE(SUM(CASE WHEN amount < 0 THEN -amount ELSE 0 END), 0) AS total_spent\nFROM public.unified_transactions\nWHERE user_id = '{user_id}'\n  AND transaction_date >= CURRENT_DATE - INTERVAL '12 months'\n  AND (LOWER(COALESCE(merchant_name, name)) LIKE '%mcdonald%')\n  AND COALESCE(pending,false)=false\n  AND COALESCE(is_cancelled,false)=false\n  AND COALESCE(is_payment,false)=false", "examples": ["how much did I spend at McDonald's in the last year", "merchant spend last 12 months"], "version": "1.0", "deprecated": false}
{"id": "merchant-spend-12m-full-if-asked", "name": "Merchant Spend (12M, Full Metrics If Asked)", "description": "Return total, count, avg, first and last txn in one query (only use if user asks for details).", "tags": ["merchant", "spend", "12m", "full"], "sql_hint": "SELECT\n  COALESCE(SUM(CASE WHEN amount < 0 THEN -amount ELSE 0 END), 0) AS total_spent,\n  COUNT(*) AS txn_count,\n  CASE WHEN COUNT(*)>0 THEN COALESCE(SUM(CASE WHEN amount < 0 THEN -amount ELSE 0 END),0)::numeric / COUNT(*) ELSE 0 END AS avg_spend,\n  MIN(transaction_date) AS first_txn,\n  MAX(transaction_date) AS last_txn\nFROM public.unified_transactions\nWHERE user_id = '{user_id}'\n  AND transaction_date >= CURRENT_DATE - INTERVAL '12 months'\n  AND (LOWER(COALESCE(merchant_name, name)) LIKE '%mcdonald%')\n  AND COALESCE(pending,false)=false\n  AND COALESCE(is_cancelled,false)=false\n  AND COALESCE(is_payment,false)=false", "examples": ["break down spend at McDonald's (count and average)", "merchant spend details"], "version": "1.0", "deprecated": false}
{"id": "discretionary-vs-essential-30d", "name": "Discretionary vs Essential Spend (30D)", "description": "Split last 30 days spend into essential vs discretionary using category heuristics.", "tags": ["budget", "classification", "30d"], "sql_hint": "WITH base AS (\n  SELECT\n    CASE\n      WHEN provider_tx_category IN ('RENT_AND_UTILITIES','MORTGAGE','HOME_IMPROVEMENT','HOME_INSURANCE','GROCERIES','TRANSPORTATION','INSURANCE','HEALTHCARE') THEN 'essential'\n      ELSE 'discretionary'\n    END AS bucket,\n    CASE WHEN amount < 0 THEN -amount ELSE 0 END AS spend\n  FROM public.unified_transactions\n  WHERE user_id = '{user_id}'\n    AND transaction_date >= CURRENT_DATE - INTERVAL '30 days'\n    AND COALESCE(pending,false)=false\n    AND COALESCE(is_cancelled,false)=false\n    AND COALESCE(is_payment,false)=false\n)\nSELECT bucket, SUM(spend) AS total_spend\nFROM base\nGROUP BY bucket\nORDER BY total_spend DESC", "examples": ["discretionary vs essential spend last 30 days", "how much of my spending is essential"], "version": "1.0", "deprecated": false}
{"id": "income-volatility-6m", "name": "Income Volatility (6M)", "description": "Compute monthly income over last 6 months, with mean and coefficient of variation.", "tags": ["income", "volatility", "6m"], "sql_hint": "WITH months AS (\n  SELECT date_trunc('month', d)::date AS month\n  FROM generate_series(\n    date_trunc('month', current_date) - interval '5 months',\n    date_trunc('month', current_date),\n    interval '1 month'\n  ) d\n),\nagg AS (\n  SELECT date_trunc('month', ut.transaction_date)::date AS month,\n         SUM(CASE WHEN ut.amount > 0 THEN ut.amount ELSE 0 END) AS monthly_income\n  FROM public.unified_transactions ut\n  WHERE ut.user_id = '{user_id}'\n    AND ut.transaction_date >= (date_trunc('month', current_date) - interval '5 months')\n    AND COALESCE(ut.pending,false)=false\n    AND COALESCE(ut.is_cancelled,false)=false\n    AND COALESCE(ut.is_payment,false)=false\n  GROUP BY 1\n),\nseries AS (\n  SELECT m.month, COALESCE(a.monthly_income,0)::numeric AS monthly_income\n  FROM months m LEFT JOIN agg a ON a.month = m.month\n)\nSELECT\n  AVG(monthly_income) AS avg_income_6m,\n  CASE WHEN STDDEV_POP(monthly_income) IS NOT NULL AND AVG(monthly_income) > 0\n       THEN STDDEV_POP(monthly_income) / AVG(monthly_income)\n       ELSE NULL END AS income_cv_6m\nFROM series", "examples": ["how volatile is my income", "income stability last 6 months"], "version": "1.0", "deprecated": false}
{"id": "largest-month-spend-ytd", "name": "Largest Month of Spending (YTD)", "description": "Identify the highest-spend month in the current year.", "tags": ["peak", "ytd", "spend"], "sql_hint": "WITH monthly AS (\n  SELECT date_trunc('month', ut.transaction_date)::date AS month,\n         SUM(CASE WHEN ut.amount < 0 THEN -ut.amount ELSE 0 END) AS monthly_spend\n  FROM public.unified_transactions ut\n  WHERE ut.user_id = '{user_id}'\n    AND ut.transaction_date >= date_trunc('year', current_date)\n    AND COALESCE(ut.pending,false)=false\n    AND COALESCE(ut.is_cancelled,false)=false\n    AND COALESCE(ut.is_payment,false)=false\n  GROUP BY 1\n)\nSELECT month, monthly_spend\nFROM monthly\nORDER BY monthly_spend DESC\nLIMIT 1", "examples": ["what was my most expensive month this year"], "version": "1.0", "deprecated": false}
{"id": "weekday-vs-weekend-spend-90d", "name": "Weekday vs Weekend Spend (90D)", "description": "Compare spending on weekdays vs weekends (last 90 days).", "tags": ["behavior", "weekday", "weekend", "90d"], "sql_hint": "WITH base AS (\n  SELECT\n    CASE WHEN EXTRACT(ISODOW FROM transaction_date) IN (6,7) THEN 'weekend' ELSE 'weekday' END AS day_type,\n    CASE WHEN amount < 0 THEN -amount ELSE 0 END AS spend\n  FROM public.unified_transactions\n  WHERE user_id = '{user_id}'\n    AND transaction_date >= CURRENT_DATE - INTERVAL '90 days'\n    AND COALESCE(pending,false)=false\n    AND COALESCE(is_cancelled,false)=false\n    AND COALESCE(is_payment,false)=false\n)\nSELECT day_type, SUM(spend) AS total_spend\nFROM base\nGROUP BY day_type\nORDER BY total_spend DESC", "examples": ["do I spend more on weekends or weekdays"], "version": "1.0", "deprecated": false}
{"id": "housing-spend-share", "name": "Housing Spend Share (Last 90 Days)", "description": "Compute housing spend share vs total spend using provider and display categories.", "tags": ["housing", "budget", "category", "share"], "sql_hint": "WITH totals AS (\n  SELECT COALESCE(SUM(-ut.amount), 0) AS total_spend\n  FROM public.unified_transactions ut\n  WHERE ut.user_id = '{user_id}'\n    AND ut.transaction_date >= CURRENT_DATE - INTERVAL '90 days'\n    AND ut.amount < 0\n    AND COALESCE(ut.pending,false)=false\n    AND COALESCE(ut.is_cancelled,false)=false\n    AND COALESCE(ut.is_payment,false)=false\n),\nhousing AS (\n  SELECT COALESCE(SUM(-ut.amount), 0) AS housing_spend\n  FROM public.unified_transactions ut\n  WHERE ut.user_id = '{user_id}'\n    AND ut.transaction_date >= CURRENT_DATE - INTERVAL '90 days'\n    AND ut.amount < 0\n    AND COALESCE(ut.pending,false)=false\n    AND COALESCE(ut.is_cancelled,false)=false\n    AND COALESCE(ut.is_payment,false)=false\n    AND (\n      ut.provider_tx_category IN ('RENT_AND_UTILITIES','MORTGAGE','HOME_IMPROVEMENT','HOME_INSURANCE')\n      OR ut.category ILIKE 'HOUSING%'\n      OR ut.category ILIKE 'RENT%'\n      OR ut.category ILIKE 'MORTGAGE%'\n      OR ut.category ILIKE 'UTILIT%'\n      OR ut.category_detailed ILIKE 'HOUSING%'\n      OR ut.category_detailed ILIKE 'RENT%'\n      OR ut.category_detailed ILIKE 'MORTGAGE%'\n      OR ut.category_detailed ILIKE 'UTILIT%'\n    )\n)\nSELECT h.housing_spend, t.total_spend,\n       CASE WHEN t.total_spend > 0 THEN h.housing_spend / t.total_spend ELSE NULL END AS housing_spend_share\nFROM housing h, totals t", "examples": ["am i spending too much on housing", "housing spend share", "how much of my spend is housing"], "version": "1.0", "deprecated": false}
{"id": "debt-to-income-ratio", "name": "Debt-to-Income Ratio (Minimum Payments)", "description": "Monthly minimum debt payments divided by recent monthly income.", "tags": ["dti", "debt", "income"], "sql_hint": "WITH income_30d AS (\n  SELECT COALESCE(SUM(ut.amount), 0) AS income_30d\n  FROM public.unified_transactions ut\n  WHERE ut.user_id = '{user_id}'\n    AND ut.transaction_date >= CURRENT_DATE - INTERVAL '30 days'\n    AND ut.amount > 0\n),\nmin_pay AS (\n  SELECT COALESCE(SUM(ul.minimum_payment_amount), 0) AS monthly_debt_payments\n  FROM public.unified_liabilities ul\n  WHERE ul.user_id = '{user_id}' AND COALESCE(ul.is_active, true) = true\n)\nSELECT m.monthly_debt_payments, i.income_30d,\n       CASE WHEN i.income_30d > 0 THEN m.monthly_debt_payments / i.income_30d ELSE NULL END AS dti\nFROM min_pay m, income_30d i", "examples": ["what's my debt-to-income ratio", "calculate my dti", "debt to income"], "version": "1.0", "deprecated": false}
{"id": "emergency-savings-recommendation", "name": "Emergency Savings Recommendation (3–6 months)", "description": "Compute average monthly spend and derive recommended 3–6 months emergency fund.", "tags": ["emergency", "savings", "budget"], "sql_hint": "WITH monthly AS (\n  SELECT DATE_TRUNC('month', ut.transaction_date) AS month,\n         SUM(CASE WHEN ut.amount < 0 THEN -ut.amount ELSE 0 END) AS monthly_spend\n  FROM public.unified_transactions ut\n  WHERE ut.user_id = '{user_id}'\n    AND ut.transaction_date >= (DATE_TRUNC('month', CURRENT_DATE) - INTERVAL '5 months')\n  GROUP BY 1\n),\navg_spend AS (\n  SELECT COALESCE(AVG(monthly_spend), 0) AS avg_monthly_spend_6m FROM monthly\n)\nSELECT a.avg_monthly_spend_6m,\n       a.avg_monthly_spend_6m * 3 AS recommended_low,\n       a.avg_monthly_spend_6m * 6 AS recommended_high\nFROM avg_spend a", "examples": ["how much should i have in emergency savings", "emergency fund recommendation", "emergency savings target"], "version": "1.0", "deprecated": false}
{"id": "time-series-spend", "name": "Time Series Spending Analysis", "description": "Track spending trends over time periods", "tags": ["timeseries", "trend", "daily"], "sql_hint": "Example: For time-based analysis, normalize dates and use flexible date ranges:\nSELECT\n  DATE_TRUNC('day', COALESCE(t.transaction_date, t.authorized_date)) AS spend_date,\n  SUM(CASE WHEN t.amount > 0 THEN t.amount ELSE 0 END) AS daily_spend,\n  COUNT(*) AS transaction_count\nFROM {transactions} t\nWHERE t.user_id = '{user_id}'\n  AND DATE_TRUNC('day', COALESCE(t.transaction_date, t.authorized_date)) >= CURRENT_DATE - INTERVAL '{days} days'\nGROUP BY spend_date\nORDER BY spend_date ASC", "examples": ["daily spending over time", "spend trend last month", "how much did I spend each day"], "version": "1.0", "deprecated": false}
{"id": "merchant-analysis", "name": "Merchant Spending Analysis", "description": "Analyze spending patterns by merchant", "tags": ["merchant", "vendor", "top-n"], "sql_hint": "Example: For merchant analysis, normalize merchant names and use flexible ranking:\nWITH merchant_summary AS (\n  SELECT\n    COALESCE(NULLIF(t.merchant_name, ''), NULLIF(t.name, '')) AS merchant,\n    SUM(CASE WHEN t.amount > 0 THEN t.amount ELSE 0 END) AS total_spend,\n    COUNT(*) AS transaction_count,\n    AVG(CASE WHEN t.amount > 0 THEN t.amount ELSE NULL END) AS avg_transaction\n  FROM {transactions} t\n  WHERE t.user_id = '{user_id}'\n    AND t.tx_date >= CURRENT_DATE - INTERVAL '{days} days'\n  GROUP BY merchant\n)\nSELECT * FROM merchant_summary\nWHERE merchant IS NOT NULL\nORDER BY total_spend DESC\nLIMIT {top_k}", "examples": ["where do I spend the most", "top merchants by spending", "merchant analysis"], "version": "1.0", "deprecated": false}
{"id": "date-range-analysis", "name": "Flexible Date Range Analysis", "description": "Handle various date range patterns flexibly", "tags": ["date", "range", "period"], "sql_hint": "Example: For flexible date handling, use normalized dates with multiple strategies:\n-- Last N days\nWHERE COALESCE(t.transaction_date, t.authorized_date) >= CURRENT_DATE - INTERVAL '{days} days'\n\n-- Specific date range\nWHERE COALESCE(t.transaction_date, t.authorized_date) BETWEEN '{start_date}' AND '{end_date}'\n\n-- Month-based\nWHERE DATE_TRUNC('month', COALESCE(t.transaction_date, t.authorized_date)) = DATE_TRUNC('month', CURRENT_DATE)\n\n-- Year-to-date\nWHERE EXTRACT(YEAR FROM COALESCE(t.transaction_date, t.authorized_date)) = EXTRACT(YEAR FROM CURRENT_DATE)", "examples": ["last month spending", "this year expenses", "spending in January"], "version": "1.0", "deprecated": false}
{"id": "emergency-fund-adequacy", "name": "Emergency Fund Coverage Analysis", "description": "Assess if liquid assets cover essential expenses for 3-12 months", "tags": ["emergency", "liquidity", "coverage", "adequacy"], "sql_hint": "WITH liquid_assets AS (\n  SELECT COALESCE(SUM(ua.estimated_value), 0) AS liquid_value\n  FROM public.unified_assets ua\n  WHERE ua.user_id = '{user_id}'\n    AND COALESCE(ua.is_active, true) = true\n    AND ua.category IN ('cash', 'checking', 'savings', 'money_market', 'cd')\n),\nessential_expenses AS (\n  SELECT COALESCE(SUM(-ut.amount), 0) AS monthly_essentials\n  FROM public.unified_transactions ut\n  WHERE ut.user_id = '{user_id}'\n    AND ut.transaction_date >= CURRENT_DATE - INTERVAL '90 days'\n    AND ut.amount < 0\n    AND COALESCE(ut.pending,false)=false\n    AND COALESCE(ut.is_cancelled,false)=false\n    AND COALESCE(ut.is_payment,false)=false\n    AND (\n      ut.provider_tx_category IN ('RENT_AND_UTILITIES','MORTGAGE','HOME_IMPROVEMENT','HOME_INSURANCE','GROCERIES','TRANSPORTATION','INSURANCE','HEALTHCARE','BANK_FEES')\n      OR ut.category ILIKE 'HOUSING%'\n      OR ut.category ILIKE 'FOOD%'\n      OR ut.category ILIKE 'TRANSPORTATION%'\n      OR ut.category ILIKE 'MEDICAL%'\n      OR ut.category ILIKE 'BANK%'\n    )\n),\nmonthly_avg AS (\n  SELECT (monthly_essentials / 3) AS avg_monthly_essentials FROM essential_expenses\n)\nSELECT\n  la.liquid_value,\n  ma.avg_monthly_essentials,\n  CASE \n    WHEN ma.avg_monthly_essentials > 0 \n    THEN la.liquid_value / ma.avg_monthly_essentials \n    ELSE NULL \n  END AS months_coverage,\n  CASE \n    WHEN ma.avg_monthly_essentials > 0 AND la.liquid_value / ma.avg_monthly_essentials >= 6 THEN 'EXCELLENT'\n    WHEN ma.avg_monthly_essentials > 0 AND la.liquid_value / ma.avg_monthly_essentials >= 3 THEN 'ADEQUATE'\n    ELSE 'INSUFFICIENT'\n  END AS adequacy_rating,\n  ma.avg_monthly_essentials * 3 AS recommended_minimum,\n  ma.avg_monthly_essentials * 6 AS recommended_optimum\nFROM liquid_assets la, monthly_avg ma", "examples": ["do I have enough emergency savings", "emergency fund coverage", "how many months can I survive financially"], "version": "1.0", "deprecated": false}
{"id": "debt-payoff-scenarios", "name": "Debt Payoff Projections", "description": "Project debt payoff timelines based on current cash flow and payment strategies", "tags": ["debt", "payoff", "projection", "scenario"], "sql_hint": "WITH debt_details AS (\n  SELECT\n    ul.name,\n    ul.principal_balance,\n    COALESCE(ul.interest_rate, 0) AS interest_rate,\n    COALESCE(ul.minimum_payment_amount, 0) AS min_payment,\n    CASE WHEN ul.is_overdue = true THEN 'HIGH' ELSE 'NORMAL' END AS priority\n  FROM public.unified_liabilities ul\n  WHERE ul.user_id = '{user_id}' AND COALESCE(ul.is_active, true) = true\n),\navailable_cash AS (\n  SELECT\n    COALESCE(SUM(ut.amount), 0) - COALESCE(SUM(CASE WHEN ut.amount < 0 THEN -ut.amount ELSE 0 END), 0) AS monthly_surplus\n  FROM public.unified_transactions ut\n  WHERE ut.user_id = '{user_id}'\n    AND ut.transaction_date >= CURRENT_DATE - INTERVAL '30 days'\n    AND COALESCE(ut.pending,false)=false\n    AND COALESCE(ut.is_cancelled,false)=false\n    AND COALESCE(ut.is_payment,false)=false\n),\ntotal_debt AS (\n  SELECT SUM(principal_balance) AS total_balance FROM debt_details\n)\nSELECT\n  dd.name,\n  dd.principal_balance,\n  dd.interest_rate,\n  dd.min_payment,\n  CASE \n    WHEN ac.monthly_surplus > dd.min_payment \n    THEN ROUND(dd.principal_balance / (ac.monthly_surplus - dd.min_payment), 1)\n    ELSE NULL \n  END AS months_to_payoff,\n  CASE \n    WHEN dd.interest_rate > 0.08 THEN 'AVOID_EXTRA_PAYMENTS'\n    WHEN dd.interest_rate < 0.04 THEN 'PAY_AGGRESSIVELY'\n    ELSE 'BALANCED_APPROACH'\n  END AS payoff_strategy\nFROM debt_details dd, available_cash ac, total_debt td\nORDER BY \n  CASE dd.priority WHEN 'HIGH' THEN 1 ELSE 2 END,\n  dd.interest_rate DESC,\n  dd.principal_balance DESC", "examples": ["how long to pay off my debt", "debt payoff calculator", "best debt payoff strategy"], "version": "1.0", "deprecated": false}
{"id": "retirement-readiness-score", "name": "Retirement Readiness Assessment", "description": "Calculate retirement preparedness using assets, savings rate, and debt levels", "tags": ["retirement", "readiness", "score", "assessment"], "sql_hint": "WITH retirement_assets AS (\n  SELECT COALESCE(SUM(ua.estimated_value), 0) AS retirement_savings\n  FROM public.unified_assets ua\n  WHERE ua.user_id = '{user_id}'\n    AND COALESCE(ua.is_active, true) = true\n    AND ua.category IN ('retirement_401k', 'retirement_ira', 'retirement_pension', 'retirement_other')\n),\ncurrent_income AS (\n  SELECT COALESCE(SUM(ut.amount), 0) AS annual_income\n  FROM public.unified_transactions ut\n  WHERE ut.user_id = '{user_id}'\n    AND ut.transaction_date >= CURRENT_DATE - INTERVAL '365 days'\n    AND ut.amount > 0\n    AND COALESCE(ut.pending,false)=false\n    AND COALESCE(ut.is_cancelled,false)=false\n    AND COALESCE(ut.is_payment,false)=false\n),\nsavings_rate AS (\n  SELECT \n    CASE WHEN SUM(CASE WHEN ut.amount > 0 THEN ut.amount ELSE 0 END) > 0 \n         THEN (SUM(CASE WHEN ut.amount > 0 THEN ut.amount ELSE 0 END) - \n               SUM(CASE WHEN ut.amount < 0 THEN -ut.amount ELSE 0 END)) / \n              SUM(CASE WHEN ut.amount > 0 THEN ut.amount ELSE 0 END)\n         ELSE 0 END AS savings_rate_pct\n  FROM public.unified_transactions ut\n  WHERE ut.user_id = '{user_id}'\n    AND ut.transaction_date >= CURRENT_DATE - INTERVAL '365 days'\n    AND COALESCE(ut.pending,false)=false\n    AND COALESCE(ut.is_cancelled,false)=false\n    AND COALESCE(ut.is_payment,false)=false\n),\ndebt_load AS (\n  SELECT COALESCE(SUM(ul.principal_balance), 0) AS total_debt\n  FROM public.unified_liabilities ul\n  WHERE ul.user_id = '{user_id}' AND COALESCE(ul.is_active, true) = true\n)\nSELECT\n  ra.retirement_savings,\n  ci.annual_income,\n  sr.savings_rate_pct,\n  dl.total_debt,\n  CASE \n    WHEN ci.annual_income > 0 THEN ra.retirement_savings / ci.annual_income ELSE 0 \n  END AS savings_to_income_ratio,\n  CASE \n    WHEN ci.annual_income > 0 THEN dl.total_debt / ci.annual_income ELSE 0 \n  END AS debt_to_income_ratio,\n  CASE \n    WHEN sr.savings_rate_pct >= 0.15 AND ra.retirement_savings / NULLIF(ci.annual_income, 0) >= 1.0 THEN 'READY'\n    WHEN sr.savings_rate_pct >= 0.10 AND ra.retirement_savings / NULLIF(ci.annual_income, 0) >= 0.5 THEN 'ON_TRACK'\n    WHEN sr.savings_rate_pct >= 0.05 THEN 'NEEDS_IMPROVEMENT'\n    ELSE 'CRITICAL'\n  END AS readiness_status,\n  CASE \n    WHEN ci.annual_income > 0 AND sr.savings_rate_pct > 0 \n    THEN ROUND((ci.annual_income * 25 - ra.retirement_savings) / (ci.annual_income * sr.savings_rate_pct), 0)\n    ELSE NULL \n  END AS years_to_25x_income\nFROM retirement_assets ra, current_income ci, savings_rate sr, debt_load dl", "examples": ["am I ready to retire", "retirement preparedness score", "retirement readiness assessment"], "version": "1.0", "deprecated": false}
{"id": "financial-stress-indicators", "name": "Financial Stress Assessment", "description": "Calculate multiple stress indicators from cash flow, debt, and asset data", "tags": ["stress", "indicators", "assessment", "financial_health"], "sql_hint": "WITH cash_flow_stress AS (\n  SELECT \n    CASE WHEN SUM(CASE WHEN ut.amount > 0 THEN ut.amount ELSE 0 END) > 0 \n         THEN 1 - (SUM(CASE WHEN ut.amount < 0 THEN -ut.amount ELSE 0 END) / \n                   SUM(CASE WHEN ut.amount > 0 THEN ut.amount ELSE 0 END))\n         ELSE -999 END AS savings_rate\n  FROM public.unified_transactions ut\n  WHERE ut.user_id = '{user_id}'\n    AND ut.transaction_date >= CURRENT_DATE - INTERVAL '30 days'\n    AND COALESCE(ut.pending,false)=false\n    AND COALESCE(ut.is_cancelled,false)=false\n    AND COALESCE(ut.is_payment,false)=false\n),\ndebt_stress AS (\n  SELECT \n    COALESCE(SUM(ul.principal_balance), 0) AS total_debt,\n    COUNT(*) AS debt_accounts,\n    COALESCE(SUM(CASE WHEN ul.is_overdue = true THEN 1 ELSE 0 END), 0) AS overdue_count\n  FROM public.unified_liabilities ul\n  WHERE ul.user_id = '{user_id}' AND COALESCE(ul.is_active, true) = true\n),\nasset_coverage AS (\n  SELECT \n    COALESCE(SUM(ua.estimated_value), 0) AS total_assets,\n    COALESCE(SUM(CASE WHEN ua.category IN ('cash', 'checking', 'savings') THEN ua.estimated_value ELSE 0 END), 0) AS liquid_assets\n  FROM public.unified_assets ua\n  WHERE ua.user_id = '{user_id}' AND COALESCE(ua.is_active, true) = true\n),\nmonthly_burn AS (\n  SELECT COALESCE(SUM(CASE WHEN ut.amount < 0 THEN -ut.amount ELSE 0 END), 0) / 3 AS avg_monthly_spend\n  FROM public.unified_transactions ut\n  WHERE ut.user_id = '{user_id}'\n    AND ut.transaction_date >= CURRENT_DATE - INTERVAL '90 days'\n    AND ut.amount < 0\n    AND COALESCE(ut.pending,false)=false\n    AND COALESCE(ut.is_cancelled,false)=false\n    AND COALESCE(ut.is_payment,false)=false\n)\nSELECT\n  cfs.savings_rate,\n  ds.total_debt,\n  ds.debt_accounts,\n  ds.overdue_count,\n  ac.total_assets,\n  ac.liquid_assets,\n  mb.avg_monthly_spend,\n  CASE WHEN mb.avg_monthly_spend > 0 THEN ac.liquid_assets / mb.avg_monthly_spend ELSE 0 END AS emergency_months,\n  CASE \n    WHEN cfs.savings_rate < -0.5 THEN 10\n    WHEN cfs.savings_rate < 0 THEN 8\n    WHEN cfs.savings_rate < 0.05 THEN 6\n    WHEN cfs.savings_rate < 0.10 THEN 4\n    WHEN cfs.savings_rate < 0.15 THEN 2\n    ELSE 0\n  END +\n  CASE \n    WHEN ds.overdue_count > 0 THEN 10\n    WHEN ds.total_debt / NULLIF(ac.total_assets, 0) > 0.5 THEN 8\n    WHEN ds.total_debt / NULLIF(ac.total_assets, 0) > 0.3 THEN 4\n    ELSE 0\n  END +\n  CASE \n    WHEN ac.liquid_assets / NULLIF(mb.avg_monthly_spend, 0) < 1 THEN 10\n    WHEN ac.liquid_assets / NULLIF(mb.avg_monthly_spend, 0) < 3 THEN 5\n    ELSE 0\n  END AS stress_score,\n  CASE \n    WHEN (CASE \n           WHEN cfs.savings_rate < -0.5 THEN 10\n           WHEN cfs.savings_rate < 0 THEN 8\n           WHEN cfs.savings_rate < 0.05 THEN 6\n           WHEN cfs.savings_rate < 0.10 THEN 4\n           WHEN cfs.savings_rate < 0.15 THEN 2\n           ELSE 0\n         END +\n         CASE \n           WHEN ds.overdue_count > 0 THEN 10\n           WHEN ds.total_debt / NULLIF(ac.total_assets, 0) > 0.5 THEN 8\n           WHEN ds.total_debt / NULLIF(ac.total_assets, 0) > 0.3 THEN 4\n           ELSE 0\n         END +\n         CASE \n           WHEN ac.liquid_assets / NULLIF(mb.avg_monthly_spend, 0) < 1 THEN 10\n           WHEN ac.liquid_assets / NULLIF(mb.avg_monthly_spend, 0) < 3 THEN 5\n           ELSE 0\n         END) >= 20 THEN 'CRITICAL'\n    WHEN (CASE \n           WHEN cfs.savings_rate < -0.5 THEN 10\n           WHEN cfs.savings_rate < 0 THEN 8\n           WHEN cfs.savings_rate < 0.05 THEN 6\n           WHEN cfs.savings_rate < 0.10 THEN 4\n           WHEN cfs.savings_rate < 0.15 THEN 2\n           ELSE 0\n         END +\n         CASE \n           WHEN ds.overdue_count > 0 THEN 10\n           WHEN ds.total_debt / NULLIF(ac.total_assets, 0) > 0.5 THEN 8\n           WHEN ds.total_debt / NULLIF(ac.total_assets, 0) > 0.3 THEN 4\n           ELSE 0\n         END +\n         CASE \n           WHEN ac.liquid_assets / NULLIF(mb.avg_monthly_spend, 0) < 1 THEN 10\n           WHEN ac.liquid_assets / NULLIF(mb.avg_monthly_spend, 0) < 3 THEN 5\n           ELSE 0\n         END) >= 10 THEN 'HIGH'\n    WHEN (CASE \n           WHEN cfs.savings_rate < -0.5 THEN 10\n           WHEN cfs.savings_rate < 0 THEN 8\n           WHEN cfs.savings_rate < 0.05 THEN 6\n           WHEN cfs.savings_rate < 0.10 THEN 4\n           WHEN cfs.savings_rate < 0.15 THEN 2\n           ELSE 0\n         END +\n         CASE \n           WHEN ds.overdue_count > 0 THEN 10\n           WHEN ds.total_debt / NULLIF(ac.total_assets, 0) > 0.5 THEN 8\n           WHEN ds.total_debt / NULLIF(ac.total_assets, 0) > 0.3 THEN 4\n           ELSE 0\n         END +\n         CASE \n           WHEN ac.liquid_assets / NULLIF(mb.avg_monthly_spend, 0) < 1 THEN 10\n           WHEN ac.liquid_assets / NULLIF(mb.avg_monthly_spend, 0) < 3 THEN 5\n           ELSE 0\n         END) >= 5 THEN 'MODERATE'\n    ELSE 'LOW'\n  END AS stress_level\nFROM cash_flow_stress cfs, debt_stress ds, asset_coverage ac, monthly_burn mb", "examples": ["how stressed is my finances", "financial stress assessment", "what are my financial stressors"], "version": "1.0", "deprecated": false}

{"id": "accounts-active-list", "name": "Active Accounts List", "description": "List all active accounts with key balances and status.", "tags": ["accounts", "list", "status"], "sql_hint": "SELECT\n  id,\n  name,\n  institution_name,\n  account_type,\n  account_subtype,\n  account_number_last4,\n  currency_code,\n  current_balance,\n  available_balance,\n  credit_limit,\n  principal_balance,\n  is_active,\n  is_overdue,\n  is_closed,\n  created_at\nFROM public.unified_accounts\nWHERE user_id = '{user_id}'\n  AND COALESCE(is_active, true) = true\nORDER BY account_type, name;", "examples": ["list my active accounts", "show accounts with balances", "what accounts do I have"], "version": "1.0", "deprecated": false}
{"id": "accounts-balance-by-type", "name": "Account Balances by Type", "description": "Aggregate balances by account_type including principal/original where applicable.", "tags": ["accounts", "balance", "aggregate"], "sql_hint": "SELECT\n  account_type,\n  SUM(COALESCE(current_balance, 0))            AS total_current_balance,\n  SUM(COALESCE(principal_balance, 0))          AS total_principal_balance,\n  SUM(COALESCE(original_principal, 0))         AS total_original_principal,\n  SUM(COALESCE(total_value, 0))                AS total_investment_value\nFROM public.unified_accounts\nWHERE user_id = '{user_id}'\n  AND COALESCE(is_active, true) = true\nGROUP BY account_type\nORDER BY total_current_balance DESC;", "examples": ["balances by account type", "sum balances per account type"], "version": "1.0", "deprecated": false}
{"id": "accounts-upcoming-min-payments", "name": "Upcoming Minimum Payments (45D)", "description": "Credit/loan/mortgage accounts with a minimum payment due in the next 45 days.", "tags": ["accounts", "payments", "upcoming"], "sql_hint": "SELECT\n  id AS account_id,\n  name AS account_name,\n  institution_name,\n  account_type,\n  minimum_payment_amount,\n  next_payment_due_date,\n  current_balance\nFROM public.unified_accounts\nWHERE user_id = '{user_id}'\n  AND COALESCE(is_active, true) = true\n  AND account_type IN ('credit','loan','mortgage')\n  AND minimum_payment_amount IS NOT NULL\n  AND minimum_payment_amount > 0\n  AND next_payment_due_date IS NOT NULL\n  AND next_payment_due_date BETWEEN CURRENT_DATE AND (CURRENT_DATE + INTERVAL '45 days')\nORDER BY next_payment_due_date ASC;", "examples": ["what bills are due soon", "upcoming minimum payments"], "version": "1.0", "deprecated": false}
{"id": "accounts-credit-utilization", "name": "Credit Utilization by Card", "description": "Compute utilization for credit accounts with safe fallbacks.", "tags": ["accounts", "credit", "utilization"], "sql_hint": "SELECT\n  id AS account_id,\n  name AS account_name,\n  institution_name,\n  credit_limit,\n  available_credit,\n  CASE\n    WHEN credit_limit IS NOT NULL AND available_credit IS NOT NULL AND credit_limit > 0\n      THEN ROUND(GREATEST(credit_limit - available_credit, 0) / credit_limit * 100, 2)\n    WHEN credit_limit IS NOT NULL AND current_balance IS NOT NULL AND credit_limit > 0\n      THEN ROUND(GREATEST(current_balance, 0) / credit_limit * 100, 2)\n    ELSE NULL\n  END AS utilization_pct\nFROM public.unified_accounts\nWHERE user_id = '{user_id}'\n  AND COALESCE(is_active, true) = true\n  AND account_type = 'credit'\n  AND (credit_limit IS NOT NULL OR available_credit IS NOT NULL OR current_balance IS NOT NULL)\nORDER BY utilization_pct DESC NULLS LAST;", "examples": ["credit utilization by card", "which cards are high utilization"], "version": "1.0", "deprecated": false}
{"id": "accounts-overdue-liabilities", "name": "Overdue Liabilities", "description": "Show overdue liability accounts with days overdue.", "tags": ["accounts", "overdue", "liabilities"], "sql_hint": "SELECT\n  id AS account_id,\n  name AS account_name,\n  account_type,\n  principal_balance,\n  current_balance,\n  minimum_payment_amount,\n  next_payment_due_date,\n  (CURRENT_DATE - DATE(next_payment_due_date))::int AS days_overdue\nFROM public.unified_accounts\nWHERE user_id = '{user_id}'\n  AND COALESCE(is_active, true) = true\n  AND COALESCE(is_overdue, false) = true\nORDER BY next_payment_due_date ASC NULLS LAST;", "examples": ["which debts are overdue", "overdue accounts"], "version": "1.0", "deprecated": false}
{"id": "accounts-30d-cashflow-by-account", "name": "30D Cash Flow by Account", "description": "Income, spend, net over last 30 days per account.", "tags": ["accounts", "transactions", "30d", "cash_flow"], "sql_hint": "WITH tx AS (\n  SELECT\n    ut.account_id,\n    SUM(CASE WHEN ut.amount < 0 THEN -ut.amount ELSE 0 END) AS spend_30d,\n    SUM(CASE WHEN ut.amount > 0 THEN ut.amount ELSE 0 END) AS income_30d\n  FROM public.unified_transactions ut\n  WHERE ut.user_id = '{user_id}'\n    AND ut.transaction_date >= CURRENT_DATE - INTERVAL '30 days'\n    AND COALESCE(ut.pending,false)=false\n    AND COALESCE(ut.is_cancelled,false)=false\n    AND COALESCE(ut.is_payment,false)=false\n  GROUP BY ut.account_id\n)\nSELECT\n  ua.id AS account_id,\n  ua.name AS account_name,\n  ua.institution_name,\n  ua.account_type,\n  ua.current_balance,\n  COALESCE(tx.spend_30d, 0)  AS spend_30d,\n  COALESCE(tx.income_30d, 0) AS income_30d,\n  COALESCE(tx.income_30d, 0) - COALESCE(tx.spend_30d, 0) AS net_30d\nFROM public.unified_accounts ua\nLEFT JOIN tx ON tx.account_id = ua.id\nWHERE ua.user_id = '{user_id}'\n  AND COALESCE(ua.is_active, true) = true\nORDER BY spend_30d DESC, income_30d DESC;", "examples": ["income and spend by account last 30 days", "which account has most spend"], "version": "1.0", "deprecated": false}
{"id": "accounts-30d-cashflow-by-type", "name": "30D Cash Flow by Account Type", "description": "Income, spend, net over last 30 days grouped by account_type.", "tags": ["accounts", "transactions", "30d", "cash_flow", "group"], "sql_hint": "WITH agg AS (\n  SELECT\n    ua.account_type,\n    SUM(CASE WHEN ut.amount < 0 THEN -ut.amount ELSE 0 END) AS spend_30d,\n    SUM(CASE WHEN ut.amount > 0 THEN ut.amount ELSE 0 END) AS income_30d\n  FROM public.unified_transactions ut\n  JOIN public.unified_accounts ua ON ua.id = ut.account_id\n  WHERE ut.user_id = '{user_id}'\n    AND ua.user_id = '{user_id}'\n    AND ut.transaction_date >= CURRENT_DATE - INTERVAL '30 days'\n    AND COALESCE(ut.pending,false)=false\n    AND COALESCE(ut.is_cancelled,false)=false\n    AND COALESCE(ut.is_payment,false)=false\n  GROUP BY ua.account_type\n)\nSELECT\n  account_type,\n  COALESCE(income_30d,0) AS income_30d,\n  COALESCE(spend_30d,0)  AS spend_30d,\n  COALESCE(income_30d,0) - COALESCE(spend_30d,0) AS net_cash_flow_30d\nFROM agg\nORDER BY net_cash_flow_30d DESC;", "examples": ["cash flow by account type last 30 days", "which types bring income"], "version": "1.0", "deprecated": false}
{"id": "accounts-debt-payments-90d", "name": "Debt Payments by Account (90D)", "description": "Identify payment transactions for debt accounts in the last 90 days.", "tags": ["accounts", "payments", "90d", "liabilities"], "sql_hint": "SELECT\n  ua.id AS account_id,\n  ua.name AS account_name,\n  ua.institution_name,\n  SUM(ABS(ut.amount)) AS total_payments_90d,\n  COUNT(*) AS payment_txn_count\nFROM public.unified_transactions ut\nJOIN public.unified_accounts ua ON ua.id = ut.account_id\nWHERE ut.user_id = '{user_id}'\n  AND ua.user_id = '{user_id}'\n  AND ut.transaction_date >= CURRENT_DATE - INTERVAL '90 days'\n  AND ua.account_type IN ('credit','loan','mortgage')\n  AND COALESCE(ut.pending,false)=false\n  AND COALESCE(ut.is_cancelled,false)=false\n  AND (\n       COALESCE(ut.is_payment,false)=true\n    OR ut.provider_tx_category IN ('LOAN_PAYMENTS','CREDIT_CARD_PAYMENTS')\n    OR COALESCE(ut.category,'') ILIKE 'PAYMENT%'\n    OR COALESCE(ut.category_detailed,'') ILIKE 'PAYMENT%'\n    OR COALESCE(ut.merchant_name, ut.name, '') ILIKE '%PAYMENT%'\n  )\nGROUP BY ua.id, ua.name, ua.institution_name\nORDER BY total_payments_90d DESC;", "examples": ["how much did I pay to debts last 90 days", "debt payments by account"], "version": "1.0", "deprecated": false}
{"id": "accounts-top-merchants-by-account-90d", "name": "Top Merchants by Account (90D)", "description": "Largest merchant spend by account in the last 90 days.", "tags": ["accounts", "merchants", "90d", "spend"], "sql_hint": "WITH base AS (\n  SELECT\n    ut.account_id,\n    COALESCE(NULLIF(ut.merchant_name,''), NULLIF(ut.name,'')) AS merchant,\n    SUM(CASE WHEN ut.amount < 0 THEN -ut.amount ELSE 0 END) AS total_spend\n  FROM public.unified_transactions ut\n  WHERE ut.user_id = '{user_id}'\n    AND ut.transaction_date >= CURRENT_DATE - INTERVAL '90 days'\n    AND COALESCE(ut.pending,false)=false\n    AND COALESCE(ut.is_cancelled,false)=false\n    AND COALESCE(ut.is_payment,false)=false\n  GROUP BY ut.account_id, COALESCE(NULLIF(ut.merchant_name,''), NULLIF(ut.name,''))\n)\nSELECT\n  ua.name AS account_name,\n  ua.institution_name,\n  b.merchant,\n  b.total_spend\nFROM base b\nJOIN public.unified_accounts ua ON ua.id = b.account_id\nWHERE ua.user_id = '{user_id}'\n  AND b.merchant IS NOT NULL\nORDER BY b.total_spend DESC\nLIMIT 25;", "examples": ["top merchants by account", "largest merchant spend by account"] , "version": "1.0", "deprecated": false}
{"id": "accounts-investment-balance-safety", "name": "Investment Balance Safety Check", "description": "Use COALESCE(total_value, current_balance) for investment types to avoid undercounting.", "tags": ["accounts", "investments", "safety"], "sql_hint": "SELECT\n  account_type,\n  SUM(COALESCE(\n        CASE WHEN account_type IN ('401k','ira','brokerage','investment_other')\n             THEN COALESCE(total_value, current_balance)\n             ELSE current_balance\n        END, 0)) AS total_value_safe\nFROM public.unified_accounts\nWHERE user_id = '{user_id}'\n  AND COALESCE(is_active, true) = true\nGROUP BY account_type\nORDER BY total_value_safe DESC;", "examples": ["investment totals safely", "avoid undercount of investment balances"], "version": "1.0", "deprecated": false}