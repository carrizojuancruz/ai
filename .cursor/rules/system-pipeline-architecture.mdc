---
alwaysApply: false
description: Complete system pipeline from memory processing to agent orchestration
globs: app/agents/**/*.py,app/services/**/*.py
---

# System Pipeline Architecture

**Core Principle:** Requests flow through a memory-augmented, multi-stage pipeline designed for contextual AI responses with persistent learning.

## ğŸš€ Complete Request Flow

### Stage 1: Memory Hotpath (Semantic Memory Creation)
```
Input: User message + conversation context
â”œâ”€â”€ Classify if message contains durable user facts
â”œâ”€â”€ Generate semantic memory (category, summary, importance)
â”œâ”€â”€ Search for similar existing memories
â”œâ”€â”€ Deduplicate/merge using similarity thresholds
â””â”€â”€ Store new semantic memory + trigger profile sync
```

### Stage 2: Memory Context (Retrieval & Injection)
```
Input: Current user query
â”œâ”€â”€ Search semantic memories by similarity
â”œâ”€â”€ Search episodic memories by recency
â”œâ”€â”€ Rerank using: similarity + importance + recency + pinned
â”œâ”€â”€ Format top memories as contextual bullets
â””â”€â”€ Inject as HumanMessage into conversation
```

### Stage 3: Supervisor Agent (Routing & Orchestration)
```
Input: User query + memory context
â”œâ”€â”€ Analyze query intent and complexity
â”œâ”€â”€ Route to specialized agent:
â”‚   â”œâ”€â”€ Finance Agent (SQL queries, financial analysis)
â”‚   â”œâ”€â”€ Onboarding Agent (user setup, profile building)
â”‚   â””â”€â”€ General Chat (fallback conversational responses)
â”œâ”€â”€ Execute agent workflow
â””â”€â”€ Format final response
```

### Stage 4: Agent Processing (Specialized Execution)

#### Finance Agent Pipeline:
```
Input: Financial query
â”œâ”€â”€ Parse query intent (spending, income, categories)
â”œâ”€â”€ Generate SQL using normalization patterns
â”œâ”€â”€ Execute against user-isolated database
â”œâ”€â”€ Format results with insights
â””â”€â”€ Return direct answer (no exploration)
```

#### Onboarding Agent Pipeline:
```
Input: User onboarding request
â”œâ”€â”€ Check current onboarding state
â”œâ”€â”€ Execute next onboarding step
â”œâ”€â”€ Update user profile and preferences
â”œâ”€â”€ Store progress in session state
â””â”€â”€ Guide user through setup flow
```

### Stage 5: Episodic Memory (Conversation Capture)
```
Input: Complete conversation turn
â”œâ”€â”€ Check cooldown timers (turns + minutes)
â”œâ”€â”€ Generate conversation summary via LLM
â”œâ”€â”€ Search for similar recent episodes
â”œâ”€â”€ Merge if similarity > threshold and within time window
â””â”€â”€ Store episodic memory for future context
```

### Stage 6: Profile Sync (Background Learning)
```
Input: New semantic memories
â”œâ”€â”€ Extract profile updates (tone, language, goals, etc.)
â”œâ”€â”€ Update user context in database
â”œâ”€â”€ Sync with external profile services
â””â”€â”€ Update cached profile data
```

## ğŸ”„ Data Flow Architecture

### Memory System Layers:
```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Episodic       â”‚    â”‚  Semantic       â”‚    â”‚  Profile        â”‚
â”‚  Memories       â”‚    â”‚  Memories       â”‚    â”‚  Context        â”‚
â”‚                 â”‚    â”‚                 â”‚    â”‚                 â”‚
â”‚ â€¢ Conversation  â”‚    â”‚ â€¢ User facts    â”‚    â”‚ â€¢ Preferences   â”‚
â”‚   summaries     â”‚    â”‚ â€¢ Preferences   â”‚    â”‚ â€¢ Goals         â”‚
â”‚ â€¢ Recent events â”‚    â”‚ â€¢ Stable data   â”‚    â”‚ â€¢ Settings      â”‚
â”‚ â€¢ Time-bound    â”‚    â”‚ â€¢ Durable       â”‚    â”‚ â€¢ Cached state  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
        â–²                        â–²                        â–²
        â”‚                        â”‚                        â”‚
        â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ Memory Context Retrieval â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### Agent Orchestration:
```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Supervisor     â”‚â”€â”€â”€â–¶â”‚  Specialized    â”‚â”€â”€â”€â–¶â”‚  Response       â”‚
â”‚  Router         â”‚    â”‚  Agents         â”‚    â”‚  Generation     â”‚
â”‚                 â”‚    â”‚                 â”‚    â”‚                 â”‚
â”‚ â€¢ Intent        â”‚    â”‚ â€¢ Finance       â”‚    â”‚ â€¢ Formatted      â”‚
â”‚   analysis      â”‚    â”‚ â€¢ Onboarding    â”‚    â”‚ â€¢ Contextual     â”‚
â”‚ â€¢ Agent         â”‚    â”‚ â€¢ General       â”‚    â”‚ â€¢ Memory-        â”‚
â”‚   selection     â”‚    â”‚   Chat          â”‚    â”‚   augmented     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

## ğŸ¯ Key Architectural Patterns

### 1. Memory-First Design
- **Every request** gets memory context injection
- **Semantic memories** capture durable user facts
- **Episodic memories** capture conversation context
- **Profile sync** maintains user model accuracy

### 2. Agent Specialization
- **Finance Agent**: SQL generation with user isolation
- **Onboarding Agent**: Guided user setup flow
- **Supervisor**: Intelligent routing and orchestration

### 3. Async Pipeline
- **Non-blocking**: All operations use async/await
- **Concurrent**: Multiple memory operations in parallel
- **Resource pooling**: Centralized connection management

### 4. Error Resilience
- **User isolation**: Every operation scoped to user_id
- **Graceful degradation**: Components fail independently
- **Retry strategies**: Different approaches for different error types

### 5. Performance Optimization
- **Lazy loading**: Expensive resources created on-demand
- **Caching**: Multi-level caching with appropriate TTLs
- **Connection pooling**: AWS and database connection reuse

## ğŸ”§ Component Integration Points

### Memory System Integration:
```python
# Memory injected into every conversation
messages = [memory_context_message] + user_messages

# Memory updated after every turn
await memory_hotpath.process(messages)
await episodic_capture.process(messages)
```

### Agent Integration:
```python
# Supervisor routes to appropriate agent
if finance_query:
    result = await finance_agent.process(query, user_id)
elif onboarding_needed:
    result = await onboarding_agent.process(query, user_id)
```

### External Service Integration:
```python
# Profile sync triggers external updates
if new_memory:
    await profile_sync.update_external(user_id, memory_data)
```

## ğŸ“Š System Characteristics

- **Memory-Augmented**: Every response enhanced with relevant context
- **User-Isolated**: Complete data isolation between users
- **Performance-First**: Optimized for low-latency responses
- **Learning System**: Continuous profile improvement through interactions
- **Modular Architecture**: Independent components with clear interfaces
- **Async-Native**: Designed for concurrent, non-blocking operations

This pipeline creates a **contextually aware, continuously learning AI system** that provides personalized responses while maintaining strict user isolation and high performance standards.